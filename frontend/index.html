<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spaced-Repetition Memory System</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .primary-btn {
            background-color: #306AE7;
        }

        .primary-btn:hover {
            background-color: #2557cc;
        }

        .primary-text {
            color: #306AE7;
        }

        .primary-bg {
            background-color: #306AE7;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_ORIGIN = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
            ? "http://localhost:5001"
            : "https://sm2-learning-system.onrender.com";

        const API = `${API_ORIGIN}/api`;

        // Parse LeetCode URL
        function parseLeetCodeURL(url) {
            try {
                const match = url.match(/leetcode\.com\/problems\/([\w-]+)/);
                if (match) {
                    const slug = match[1];
                    const name = slug.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    const numMatch = url.match(/\/(\d+)\//);
                    const num = numMatch ? numMatch[1] : '';
                    return { name, num: num || slug };
                }
            } catch (e) { }
            return null;
        }

        function App() {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [user, setUser] = useState(localStorage.getItem('username'));

            if (!token) return <Login onLogin={(t, u) => { localStorage.setItem('token', t); localStorage.setItem('username', u); setToken(t); setUser(u); }} />;

            const logout = () => { localStorage.clear(); setToken(null); setUser(null); };
            return <Main user={user} token={token} onLogout={logout} />;
        }

        function Login({ onLogin }) {
            const [mode, setMode] = useState('login');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const submit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    const res = await fetch(`${API}/auth/${mode}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (res.ok) onLogin(data.token, data.username);
                    else setError(data.error || 'Operation failed');
                } catch (e) {
                    setError('Network error');
                }
            };

            return (
                <div className="min-h-screen bg-white flex items-center justify-center">
                    <div className="bg-white border-2 border-gray-200 rounded-3xl shadow-xl p-10 w-96">
                        <div className="text-center mb-8">
                            <div className="w-20 h-20 rounded-full flex items-center justify-center text-white font-bold text-3xl mx-auto mb-4 primary-bg">SR</div>
                            <h1 className="text-3xl font-bold mb-2">Spaced-Repetition</h1>
                            <p className="text-gray-500">Memory System</p>
                        </div>
                        <div className="flex mb-6 bg-gray-100 rounded-lg p-1">
                            <button onClick={() => setMode('login')} className={`flex-1 py-2 rounded-lg font-medium ${mode === 'login' ? 'bg-white shadow' : ''}`}>Login</button>
                            <button onClick={() => setMode('register')} className={`flex-1 py-2 rounded-lg font-medium ${mode === 'register' ? 'bg-white shadow' : ''}`}>Register</button>
                        </div>
                        <form onSubmit={submit} className="space-y-4">
                            <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full border-2 rounded-lg px-4 py-3" placeholder="Username" required />
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full border-2 rounded-lg px-4 py-3" placeholder="Password (min 6 chars)" required minLength="6" />
                            {error && <div className="bg-red-50 p-3 rounded text-red-700 text-sm">{error}</div>}
                            <button type="submit" className="w-full primary-btn text-white py-3 rounded-lg font-medium">{mode === 'login' ? 'Login' : 'Register'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function Main({ user, token, onLogout }) {
            const [tab, setTab] = useState('library');
            const [cards, setCards] = useState([]);
            const [filtered, setFiltered] = useState([]);
            const [due, setDue] = useState([]);
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [stats, setStats] = useState({ total_cards: 0, due_today: 0 });
            const [msg, setMsg] = useState('');
            const [done, setDone] = useState(new Set());
            const [tags, setTags] = useState([]);
            const [search, setSearch] = useState('');
            const [filterTags, setFilterTags] = useState([]);
            const [filterProf, setFilterProf] = useState('all');
            const [dateStart, setDateStart] = useState('');
            const [dateEnd, setDateEnd] = useState('');
            const [showAdd, setShowAdd] = useState(false);
            const [showBatch, setShowBatch] = useState(false);
            const [showNote, setShowNote] = useState(false);
            const [showHist, setShowHist] = useState(false);
            const [curr, setCurr] = useState(null);
            const [page, setPage] = useState(1);
            const perPage = 100;

            const api = async (url, opt = {}) => {
                const h = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...opt.headers };
                return fetch(`${API}${url}`, { ...opt, headers: h });
            };

            useEffect(() => {
                load();
            }, [tab, date]);

            useEffect(() => {
                filter();
            }, [cards, search, filterTags, filterProf, dateStart, dateEnd]);

            const load = async () => {
                try {
                    const r1 = await api('/stats');
                    if (r1.ok) {
                        const d1 = await r1.json();
                        setStats(d1);
                    }

                    const r2 = await api('/tags');
                    if (r2.ok) {
                        const d2 = await r2.json();
                        setTags(d2.tags || []);
                    }

                    if (tab === 'today') {
                        const r3 = await api('/cards/due', { method: 'POST', body: JSON.stringify({ date }) });
                        if (r3.ok) {
                            const d3 = await r3.json();
                            setDue(d3.cards || []);
                        }
                    } else {
                        const r4 = await api('/cards');
                        if (r4.ok) {
                            const d4 = await r4.json();
                            setCards(d4.cards || []);
                        }
                    }
                } catch (e) {
                    console.error('Load error:', e);
                }
            };

            const filter = () => {
                let f = [...cards];
                if (search) f = f.filter(c => c.card_id.includes(search));
                if (filterTags.length) f = f.filter(c => filterTags.some(t => c.tags?.includes(t)));
                if (filterProf !== 'all') {
                    f = f.filter(c => {
                        const s = c.ef >= 2.8 ? 5 : c.ef >= 2.5 ? 4 : c.ef >= 2.2 ? 3 : c.ef >= 1.8 ? 2 : 1;
                        return s === parseInt(filterProf);
                    });
                }
                if (dateStart) f = f.filter(c => c.first_date >= dateStart);
                if (dateEnd) f = f.filter(c => c.first_date <= dateEnd);
                setFiltered(f);
            };

            const review = async (id, score) => {
                try {
                    const res = await api('/cards/review', { method: 'POST', body: JSON.stringify({ card_id: id, score, review_date: date }) });
                    if (res.ok) {
                        setDone(prev => new Set([...prev, id]));
                        setMsg('Review successful');
                        setTimeout(() => setMsg(''), 2000);
                        // Âè™ÈáçÊñ∞Âä†ËΩΩÁªüËÆ°Êï∞ÊçÆÔºå‰∏çÈáçÊñ∞Âä†ËΩΩdueÂàóË°®
                        const r1 = await api('/stats');
                        if (r1.ok) {
                            const d1 = await r1.json();
                            setStats(d1);
                        }
                    }
                } catch (e) {
                    setMsg('Review failed');
                    setTimeout(() => setMsg(''), 2000);
                }
            };

            const add = async (id, name, score, cardTags, link) => {
                try {
                    const res = await api('/cards/add', {
                        method: 'POST',
                        body: JSON.stringify({
                            card_id: id,
                            name: name || '',
                            first_date: date,
                            score,
                            tags: cardTags || [],
                            link: link || ''
                        })
                    });
                    if (res.ok) {
                        setMsg('Added successfully');
                        setTimeout(() => setMsg(''), 2000);
                        load();
                        return true;
                    } else {
                        const data = await res.json();
                        setMsg(data.error || 'Add failed');
                        setTimeout(() => setMsg(''), 4000);
                        return false;
                    }
                } catch (e) {
                    setMsg('Network error');
                    setTimeout(() => setMsg(''), 2000);
                    return false;
                }
            };

            const batchAdd = async (items) => {
                try {
                    const res = await api('/cards/batch', {
                        method: 'POST',
                        body: JSON.stringify({ cards: items, date })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setMsg(`Added ${data.added.length} cards, Reviewed ${data.reviewed.length} cards`);
                        setTimeout(() => setMsg(''), 3000);
                        load();
                        return true;
                    }
                } catch (e) {
                    setMsg('Batch add failed');
                    setTimeout(() => setMsg(''), 2000);
                }
                return false;
            };

            const update = async (id, upd) => {
                try {
                    const res = await api('/cards/update', { method: 'POST', body: JSON.stringify({ card_id: id, ...upd }) });
                    if (res.ok) {
                        load();
                        return true;
                    }
                    return false;
                } catch (e) {
                    return false;
                }
            };

            const del = async (id) => {
                if (!confirm('Are you sure to delete this card?')) return;
                try {
                    const res = await api(`/cards/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        setMsg('Deleted successfully');
                        setTimeout(() => setMsg(''), 2000);
                        load();
                    }
                } catch (e) {
                    setMsg('Delete failed');
                    setTimeout(() => setMsg(''), 2000);
                }
            };

            const start = (page - 1) * perPage;
            const current = filtered.slice(start, start + perPage);
            const totalPages = Math.ceil(filtered.length / perPage);

            // Sort due cards: unreviewed first, reviewed last
            const sortedDue = [...due].sort((a, b) => {
                const aDone = done.has(a.card_id);
                const bDone = done.has(b.card_id);
                if (aDone && !bDone) return 1;
                if (!aDone && bDone) return -1;
                return 0;
            });

            return (
                <div className="min-h-screen bg-gray-50">
                    {msg && <div className="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">{msg}</div>}

                    <div className="bg-white shadow">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between">
                            <div className="flex items-center space-x-4">
                                <div className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold primary-bg">SR</div>
                                <div>
                                    <h1 className="text-xl font-bold">Spaced-Repetition Memory System</h1>
                                    <p className="text-xs text-gray-500">Intelligent Learning Scheduler</p>
                                </div>
                            </div>
                            <div className="flex items-center space-x-6">
                                <div className="text-center">
                                    <div className="text-sm text-gray-500">Today's Progress</div>
                                    <div className="text-xl font-bold"><span className="text-green-600">{done.size}</span>/<span className="primary-text">{due.length}</span></div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-500">Total Cards</div>
                                    <div className="text-xl font-bold primary-text">{stats.total_cards || 0}</div>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <span className="text-gray-600">{user}</span>
                                    <button onClick={onLogout} className="text-sm text-red-500 hover:text-red-700">Logout</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-6 py-8">
                        <div className="bg-white rounded-t-xl shadow border-b">
                            <div className="flex">
                                <button onClick={() => setTab('library')} className={`px-8 py-4 font-semibold ${tab === 'library' ? 'primary-text border-b-4' : 'text-gray-500'}`} style={tab === 'library' ? { borderColor: '#306AE7' } : {}}>Library</button>
                                <button onClick={() => setTab('today')} className={`px-8 py-4 font-semibold ${tab === 'today' ? 'primary-text border-b-4' : 'text-gray-500'}`} style={tab === 'today' ? { borderColor: '#306AE7' } : {}}>Today's Review</button>
                            </div>
                        </div>

                        <div className="bg-white rounded-b-xl shadow-lg p-8">
                            {tab === 'today' ? (
                                <TodayView date={date} setDate={setDate} due={sortedDue} done={done} review={review} setShowBatch={setShowBatch} update={update} />
                            ) : (
                                <Library cards={current} total={filtered.length} page={page} setPage={setPage} totalPages={totalPages} setShowAdd={setShowAdd} update={update} del={del} search={search} setSearch={setSearch} filterTags={filterTags} setFilterTags={setFilterTags} filterProf={filterProf} setFilterProf={setFilterProf} dateStart={dateStart} setDateStart={setDateStart} dateEnd={dateEnd} setDateEnd={setDateEnd} tags={tags} allTags={tags} setCurr={setCurr} setShowNote={setShowNote} setShowHist={setShowHist} />
                            )}
                        </div>
                    </div>

                    {showAdd && <AddModal date={date} setDate={setDate} onAdd={add} onClose={() => setShowAdd(false)} />}
                    {showBatch && <BatchModal date={date} setDate={setDate} onAdd={batchAdd} onClose={() => setShowBatch(false)} />}
                    {showNote && curr && <NoteEditor card={curr} token={token} onSave={(note) => { update(curr.card_id, { note }); setShowNote(false); setCurr(null); setMsg('Note saved'); setTimeout(() => setMsg(''), 2000); }} onClose={() => { setShowNote(false); setCurr(null); }} />}
                    {showHist && curr && <HistModal card={curr} onClose={() => { setShowHist(false); setCurr(null); }} />}
                </div>
            );
        }

        function TodayView({ date, setDate, due, done, review, setShowBatch, update }) {
            return (
                <>
                    <div className="mb-8 flex justify-between">
                        <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="border-2 rounded-lg px-4 py-2" />
                        <button onClick={() => setShowBatch(true)} className="primary-btn text-white px-6 py-3 rounded-lg">+ Add Card</button>
                    </div>
                    {due.length === 0 ? (
                        <div className="text-center py-20"><div className="text-6xl mb-4">üéâ</div><p className="text-2xl text-gray-600">No cards to review today!</p></div>
                    ) : (
                        <table className="w-full">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-4 py-3 text-left font-semibold">Done</th>
                                    <th className="px-4 py-3 text-left font-semibold">Stars</th>
                                    <th className="px-4 py-3 text-left font-semibold">ID</th>
                                    <th className="px-4 py-3 text-left font-semibold">Name</th>
                                    <th className="px-4 py-3 text-left font-semibold">Tags</th>
                                    <th className="px-4 py-3 text-left font-semibold">Link</th>
                                    <th className="px-4 py-3 text-left font-semibold">Rating</th>
                                    <th className="px-4 py-3 text-left font-semibold">Review Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                {due.map((c, i) => {
                                    const s = c.ef >= 2.8 ? 5 : c.ef >= 2.5 ? 4 : c.ef >= 2.2 ? 3 : c.ef >= 1.8 ? 2 : 1;
                                    const isDone = done.has(c.card_id);
                                    return (
                                        <tr key={i} className={isDone ? 'bg-green-50 opacity-70' : 'hover:bg-blue-50'}>
                                            <td className="px-4 py-3">{isDone && <span className="text-green-600 text-xl">‚úì</span>}</td>
                                            <td className="px-4 py-3 text-sm">{'‚≠ê'.repeat(s)}</td>
                                            <td className="px-4 py-3 font-bold">{c.card_id}</td>
                                            <td className="px-4 py-3"><EditField val={c.name} save={(v) => update(c.card_id, { name: v })} placeholder="Add name" /></td>
                                            <td className="px-4 py-3"><Tags tags={c.tags || []} save={(t) => update(c.card_id, { tags: t })} /></td>
                                            <td className="px-4 py-3">
                                                {c.link ? <a href={c.link} target="_blank" className="primary-text text-sm hover:underline">Open</a> : <span className="text-gray-400 text-sm">-</span>}
                                            </td>
                                            <td className="px-4 py-3">
                                                <div className="flex space-x-2">
                                                    {[1, 2, 3, 4, 5].map(n => (
                                                        <button key={n} onClick={() => review(c.card_id, n)} disabled={isDone} className={`w-10 h-10 border-2 rounded font-bold ${isDone ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'hover:text-white'}`} style={isDone ? {} : { borderColor: '#306AE7' }} onMouseEnter={(e) => !isDone && (e.target.style.backgroundColor = '#306AE7')} onMouseLeave={(e) => !isDone && (e.target.style.backgroundColor = 'white')}>{n}</button>
                                                    ))}
                                                </div>
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.review_count || 0} times</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    )}
                </>
            );
        }

        function Library({ cards, total, page, setPage, totalPages, setShowAdd, update, del, search, setSearch, filterTags, setFilterTags, filterProf, setFilterProf, dateStart, setDateStart, dateEnd, setDateEnd, tags, allTags, setCurr, setShowNote, setShowHist }) {
            const [showTags, setShowTags] = useState(false);
            const [menu, setMenu] = useState(null);

            return (
                <>
                    <div className="mb-6 bg-gray-50 border-2 rounded-xl p-6 pb-20 relative">
                        <div className="grid grid-cols-4 gap-4">
                            <div><label className="block text-sm mb-2 font-medium">Problem ID</label><input value={search} onChange={(e) => setSearch(e.target.value)} className="w-full border-2 rounded px-4 py-2" placeholder="Search..." /></div>
                            <div className="relative">
                                <label className="block text-sm mb-2 font-medium">Tags</label>
                                <button onClick={() => setShowTags(!showTags)} className="w-full border-2 rounded px-4 py-2 bg-white flex justify-between">
                                    <span className="truncate">{filterTags.length ? `${filterTags.length} selected` : 'Select'}</span><span>‚ñº</span>
                                </button>
                                {showTags && (
                                    <div className="absolute z-10 mt-1 w-full bg-white border-2 rounded shadow-lg max-h-64 overflow-y-auto">
                                        <div onClick={() => setFilterTags(filterTags.length === tags.length ? [] : [...tags])} className="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b bg-gray-50">
                                            <input type="checkbox" checked={filterTags.length === tags.length && tags.length > 0} readOnly className="mr-2" />Select All
                                        </div>
                                        {tags.length === 0 ? (
                                            <div className="px-4 py-2 text-gray-400 text-sm">No tags</div>
                                        ) : (
                                            tags.map(t => (
                                                <div key={t} onClick={() => setFilterTags(filterTags.includes(t) ? filterTags.filter(x => x !== t) : [...filterTags, t])} className="px-4 py-2 hover:bg-blue-50 cursor-pointer">
                                                    <input type="checkbox" checked={filterTags.includes(t)} readOnly className="mr-2" />{t}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                            </div>
                            <div><label className="block text-sm mb-2 font-medium">Proficiency</label>
                                <select value={filterProf} onChange={(e) => setFilterProf(e.target.value)} className="w-full border-2 rounded px-3 py-2 text-sm">
                                    <option value="all">All</option>
                                    {[5, 4, 3, 2, 1].map(n => <option key={n} value={n}>{n} Star{n > 1 ? 's' : ''}</option>)}
                                </select>
                            </div>
                            <div><label className="block text-sm mb-2 font-medium">Date Range</label>
                                <div className="flex space-x-2">
                                    <input type="date" value={dateStart} onChange={(e) => setDateStart(e.target.value)} className="w-1/2 border-2 rounded px-2 py-2 text-sm" />
                                    <input type="date" value={dateEnd} onChange={(e) => setDateEnd(e.target.value)} className="w-1/2 border-2 rounded px-2 py-2 text-sm" />
                                </div>
                            </div>
                        </div>
                        <div className="absolute bottom-6 right-6">
                            <button onClick={() => setShowAdd(true)} className="primary-btn text-white px-6 py-3 rounded-lg font-medium">+ Add Card</button>
                        </div>
                    </div>

                    <div className="mb-4 text-sm text-gray-600">Total: <span className="font-bold primary-text">{total}</span> cards</div>

                    <table className="w-full mb-8">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-4 py-3 text-left font-semibold">Stars</th>
                                <th className="px-4 py-3 text-left font-semibold">ID</th>
                                <th className="px-4 py-3 text-left font-semibold">Name</th>
                                <th className="px-4 py-3 text-left font-semibold">Tags</th>
                                <th className="px-4 py-3 text-left font-semibold">Last Completed</th>
                                <th className="px-4 py-3 text-left font-semibold">Next Review</th>
                                <th className="px-4 py-3 text-left font-semibold">Review Count</th>
                                <th className="px-4 py-3 text-left font-semibold">Link</th>
                                <th className="px-4 py-3 text-left font-semibold">Note</th>
                                <th className="px-4 py-3 text-left font-semibold">More</th>
                            </tr>
                        </thead>
                        <tbody>
                            {cards.length === 0 ? (
                                <tr><td colSpan="10" className="text-center py-20 text-gray-400">No data</td></tr>
                            ) : (
                                cards.map((c, i) => {
                                    const s = c.ef >= 2.8 ? 5 : c.ef >= 2.5 ? 4 : c.ef >= 2.2 ? 3 : c.ef >= 1.8 ? 2 : 1;
                                    return (
                                        <tr key={i} className="border-t hover:bg-blue-50">
                                            <td className="px-4 py-3 text-sm">{'‚≠ê'.repeat(s)}</td>
                                            <td className="px-4 py-3 font-bold"><EditField val={c.card_id} save={(v) => update(c.card_id, { new_card_id: v })} placeholder="ID" /></td>
                                            <td className="px-4 py-3 max-w-xs truncate"><EditField val={c.name} save={(v) => update(c.card_id, { name: v })} placeholder="Name" /></td>
                                            <td className="px-4 py-3"><TagsWithDropdown tags={c.tags || []} allTags={allTags} save={(t) => update(c.card_id, { tags: t })} /></td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.last_review_date || c.first_date}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.next_review || '-'}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.review_count || 0}</td>
                                            <td className="px-4 py-3">{c.link ? <a href={c.link} target="_blank" className="primary-text text-sm hover:underline">Open</a> : <span className="text-gray-400 text-sm">-</span>}</td>
                                            <td className="px-4 py-3"><button onClick={() => { setCurr(c); setShowNote(true); }} className="primary-text text-sm hover:underline">{c.note ? 'View' : 'Add'}</button></td>
                                            <td className="px-4 py-3 relative">
                                                <button onClick={() => setMenu(menu === i ? null : i)} className="text-gray-600 text-sm px-3 py-1 border rounded hover:bg-gray-50">More</button>
                                                {menu === i && (
                                                    <div className="absolute right-0 mt-1 bg-white border-2 shadow-lg rounded z-10 w-36">
                                                        <button onClick={() => { setCurr(c); setShowHist(true); setMenu(null); }} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">View History</button>
                                                        <button onClick={() => { del(c.card_id); setMenu(null); }} className="block w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 text-sm">Delete</button>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>

                    {totalPages > 1 && (
                        <div className="flex justify-center space-x-2">
                            <button onClick={() => setPage(Math.max(1, page - 1))} disabled={page === 1} className={`px-4 py-2 border-2 rounded ${page === 1 ? 'opacity-50' : ''}`}>‚Üê</button>
                            {Array.from({ length: Math.min(5, totalPages) }, (_, i) => i + 1).map(p => (
                                <button key={p} onClick={() => setPage(p)} className={`px-4 py-2 rounded ${page === p ? 'primary-btn text-white' : 'border-2'}`}>{p}</button>
                            ))}
                            <button onClick={() => setPage(Math.min(totalPages, page + 1))} disabled={page === totalPages} className={`px-4 py-2 border-2 rounded ${page === totalPages ? 'opacity-50' : ''}`}>‚Üí</button>
                        </div>
                    )}
                </>
            );
        }

        function EditField({ val, save, placeholder }) {
            const [edit, setEdit] = useState(false);
            const [text, setText] = useState(val || '');

            useEffect(() => {
                setText(val || '');
            }, [val]);

            if (edit) return <input value={text} onChange={(e) => setText(e.target.value)} onBlur={() => { if (text !== val) save(text); setEdit(false); }} onKeyPress={(e) => e.key === 'Enter' && setEdit(false)} className="border rounded px-2 py-1 text-sm w-full" autoFocus />;
            return <div onClick={() => setEdit(true)} className="cursor-pointer hover:bg-gray-100 px-2 py-1 rounded truncate">{val || <span className="text-gray-400 text-sm">{placeholder}</span>}</div>;
        }

        function Tags({ tags, save }) {
            const [edit, setEdit] = useState(false);
            const [tag, setTag] = useState('');
            return (
                <div className="flex flex-wrap gap-1">
                    {tags.map(t => <span key={t} className="px-2 py-1 rounded-full text-xs" style={{ backgroundColor: '#E8EFFD', color: '#306AE7' }}>{t}<button onClick={() => save(tags.filter(x => x !== t))} className="ml-1 hover:text-red-600">√ó</button></span>)}
                    {edit ? <input value={tag} onChange={(e) => setTag(e.target.value)} onBlur={() => { if (tag.trim()) save([...tags, tag.trim()]); setEdit(false); setTag(''); }} onKeyPress={(e) => e.key === 'Enter' && tag.trim() && (save([...tags, tag.trim()]), setEdit(false), setTag(''))} className="border rounded px-2 py-1 text-xs w-20" autoFocus placeholder="Tag..." /> : <button onClick={() => setEdit(true)} className="primary-text text-xs hover:underline">+ Add</button>}
                </div>
            );
        }

        function TagsWithDropdown({ tags, allTags, save }) {
            const [showDropdown, setShowDropdown] = useState(false);
            const [edit, setEdit] = useState(false);
            const [newTag, setNewTag] = useState('');

            const addExisting = (tag) => {
                if (!tags.includes(tag)) {
                    save([...tags, tag]);
                }
            };

            return (
                <div className="relative">
                    <div className="flex flex-wrap gap-1">
                        {tags.map(t => <span key={t} className="px-2 py-1 rounded-full text-xs" style={{ backgroundColor: '#E8EFFD', color: '#306AE7' }}>{t}<button onClick={() => save(tags.filter(x => x !== t))} className="ml-1 hover:text-red-600">√ó</button></span>)}
                        {edit ? (
                            <input value={newTag} onChange={(e) => setNewTag(e.target.value)} onBlur={() => { if (newTag.trim()) save([...tags, newTag.trim()]); setEdit(false); setNewTag(''); }} onKeyPress={(e) => e.key === 'Enter' && newTag.trim() && (save([...tags, newTag.trim()]), setEdit(false), setNewTag(''))} className="border rounded px-2 py-1 text-xs w-20" autoFocus placeholder="New..." />
                        ) : (
                            <button onClick={() => setShowDropdown(!showDropdown)} className="primary-text text-xs hover:underline">+ Add</button>
                        )}
                    </div>
                    {showDropdown && (
                        <div className="absolute z-20 mt-1 bg-white border-2 rounded shadow-lg w-48 max-h-48 overflow-y-auto">
                            <button onClick={() => { setShowDropdown(false); setEdit(true); }} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm primary-text">+ New Tag</button>
                            <div className="border-t"></div>
                            {allTags.filter(t => !tags.includes(t)).map(t => (
                                <button key={t} onClick={() => { addExisting(t); setShowDropdown(false); }} className="block w-full text-left px-4 py-2 hover:bg-blue-50 text-sm">{t}</button>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function AddModal({ date, setDate, onAdd, onClose }) {
            const [id, setId] = useState('');
            const [name, setName] = useState('');
            const [score, setScore] = useState(3);
            const [tags, setTags] = useState([]);
            const [link, setLink] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                setDate(new Date().toISOString().split('T')[0]);
            }, []);

            const handleLinkPaste = (e) => {
                const pastedText = e.target.value;
                setLink(pastedText);

                const parsed = parseLeetCodeURL(pastedText);
                if (parsed) {
                    setId(parsed.num);
                    setName(parsed.name);
                }
            };

            const submit = async () => {
                if (!id.trim()) {
                    setError('Please enter problem ID');
                    return;
                }
                setError('');
                const success = await onAdd(id.trim(), name, score, tags, link);
                if (success) onClose();
                else setError('Failed to add card');
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl p-8 w-[500px]">
                        <h3 className="text-2xl font-bold mb-6">Add New Card</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm mb-2 font-medium">LeetCode Link (Optional)</label>
                                <input type="text" value={link} onChange={handleLinkPaste} placeholder="https://leetcode.com/problems/..." className="w-full border-2 rounded px-4 py-3 text-sm" />
                                <p className="text-xs text-gray-500 mt-1">Paste LeetCode URL to auto-fill ID and name</p>
                            </div>
                            <div>
                                <label className="block text-sm mb-2 font-medium">Problem ID *</label>
                                <input type="text" value={id} onChange={(e) => { setId(e.target.value); setError(''); }} placeholder="e.g., 217" className="w-full border-2 rounded px-4 py-3" />
                            </div>
                            <div>
                                <label className="block text-sm mb-2 font-medium">Problem Name</label>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Two Sum" className="w-full border-2 rounded px-4 py-3" />
                            </div>
                            <div>
                                <label className="block text-sm mb-2 font-medium">Completion Date</label>
                                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full border-2 rounded px-4 py-3" />
                            </div>
                            <div>
                                <label className="block text-sm mb-2 font-medium">Rating (1-5)</label>
                                <div className="flex space-x-2">
                                    {[1, 2, 3, 4, 5].map(s => <button key={s} type="button" onClick={() => setScore(s)} className={`flex-1 py-3 rounded font-bold ${score === s ? 'primary-btn text-white' : 'bg-gray-100'}`}>{s}</button>)}
                                </div>
                            </div>
                            {error && <div className="bg-red-50 border-l-4 border-red-500 p-3 rounded"><p className="text-red-700 text-sm">{error}</p></div>}
                            <div className="flex space-x-3">
                                <button type="button" onClick={onClose} className="flex-1 border-2 rounded px-6 py-3 hover:bg-gray-50">Cancel</button>
                                <button type="button" onClick={submit} className="flex-1 primary-btn text-white rounded px-6 py-3">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function BatchModal({ date, setDate, onAdd, onClose }) {
            const [text, setText] = useState('');

            useEffect(() => {
                setDate(new Date().toISOString().split('T')[0]);
            }, []);

            const submit = async () => {
                const items = text.split('\n').filter(l => l.trim()).map(l => {
                    const [id, s] = l.split(':');
                    return { card_id: id.trim(), score: parseInt(s) || 3 };
                });
                if (items.length > 0 && await onAdd(items)) onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl p-8 w-[700px]">
                        <h3 className="text-2xl font-bold mb-6">Batch Add Cards</h3>
                        <div>
                            <label className="block text-sm mb-2 font-medium">Completion Date</label>
                            <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="mb-4 border-2 rounded px-4 py-2" />
                        </div>
                        <div>
                            <label className="block text-sm mb-2 font-medium">Format: ID:Score (one per line)</label>
                            <textarea value={text} onChange={(e) => setText(e.target.value)} className="w-full border-2 rounded px-4 py-3 h-64 font-mono text-sm" placeholder="Example:&#10;201:4&#10;202:3&#10;203:5" />
                        </div>
                        <div className="flex space-x-3 mt-4">
                            <button onClick={onClose} className="flex-1 border-2 rounded px-6 py-3 hover:bg-gray-50">Cancel</button>
                            <button onClick={submit} className="flex-1 primary-btn text-white rounded px-6 py-3">Submit</button>
                        </div>
                    </div>
                </div>
            );
        }

        function NoteEditor({ card, token, onSave, onClose }) {
            const [content, setContent] = useState(card.note || '');
            const ref = useRef(null);
            const q = useRef(null);

            useEffect(() => {
                if (!window.Quill) {
                    const link = document.createElement('link');
                    link.href = 'https://cdn.quilljs.com/1.3.6/quill.snow.css';
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                    const script = document.createElement('script');
                    script.src = 'https://cdn.quilljs.com/1.3.6/quill.js';
                    script.onload = init;
                    document.body.appendChild(script);
                } else init();
            }, []);

            const init = () => {
                if (q.current || !ref.current) return;
                const quill = new window.Quill(ref.current, {
                    theme: 'snow',
                    modules: { toolbar: [['bold', 'italic'], ['code-block'], ['image']] },
                    placeholder: 'Enter notes...'
                });
                if (card.note) quill.root.innerHTML = card.note;
                quill.on('text-change', () => setContent(quill.root.innerHTML));
                quill.getModule('toolbar').addHandler('image', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.click();
                    input.onchange = () => {
                        const file = input.files[0];
                        if (file) {
                            const fd = new FormData();
                            fd.append('file', file);
                            fd.append('card_id', card.card_id);
                            fetch(`${API}/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd })
                                .then(r => r.json())
                                .then(d => {
                                    const range = quill.getSelection(true);
                                    quill.insertEmbed(range.index, 'image', `${API_ORIGIN}/api/images/${d.filename}`);
                                })
                                .catch(e => alert('Upload failed'));
                        }
                    };
                });

                quill.root.addEventListener('paste', (e) => {
                    const items = e.clipboardData.items;
                    for (let item of items) {
                        if (item.type.indexOf('image') !== -1) {
                            e.preventDefault();
                            const file = item.getAsFile();
                            const fd = new FormData();
                            fd.append('file', file);
                            fd.append('card_id', card.card_id);
                            fetch(`${API}/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd })
                                .then(r => r.json())
                                .then(d => {
                                    const range = quill.getSelection(true);
                                    quill.insertEmbed(range.index, 'image', `${API_ORIGIN}/api/images/${d.filename}`);
                                })
                                .catch(e => alert('Upload failed'));
                        }
                    }
                });

                q.current = quill;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl w-[90vw] h-[90vh] flex flex-col">
                        <div className="p-6 border-b flex justify-between" style={{ backgroundColor: '#F0F4FD' }}>
                            <h3 className="text-2xl font-bold">Card {card.card_id} - Notes</h3>
                            <button onClick={onClose} className="text-3xl hover:text-red-600">√ó</button>
                        </div>
                        <div className="flex-1 p-6"><div ref={ref} className="h-full border-2 rounded" /></div>
                        <div className="p-6 border-t flex justify-end space-x-4">
                            <button onClick={onClose} className="px-6 py-3 border-2 rounded hover:bg-gray-50">Cancel</button>
                            <button onClick={() => onSave(content)} className="px-6 py-3 primary-btn text-white rounded">Save</button>
                        </div>
                    </div>
                </div>
            );
        }

        function HistModal({ card, onClose }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl p-8 w-96">
                        <div className="flex justify-between mb-6">
                            <h3 className="text-xl font-bold">Card {card.card_id} - History</h3>
                            <button onClick={onClose} className="text-2xl hover:text-red-600">√ó</button>
                        </div>
                        <div className="space-y-2 text-sm">
                            <div><span className="text-gray-500">First Completed:</span> <span className="font-medium">{card.first_date}</span></div>
                            <div><span className="text-gray-500">Last Review:</span> <span className="font-medium">{card.last_review_date || card.first_date}</span></div>
                            <div><span className="text-gray-500">Review Count:</span> <span className="font-medium">{card.review_count || 0} times</span></div>
                            <div><span className="text-gray-500">Interval:</span> <span className="font-medium">{card.interval || 0} days</span></div>
                            <div><span className="text-gray-500">Next Review:</span> <span className="font-medium">{card.next_review || '-'}</span></div>
                        </div>
                        <button onClick={onClose} className="w-full mt-6 py-2 bg-gray-100 rounded hover:bg-gray-200">Close</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>

</html>