<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MemoCode</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .primary-btn {
            background-color: #306AE7;
        }

        .primary-btn:hover {
            background-color: #2557cc;
        }

        .primary-text {
            color: #306AE7;
        }

        .primary-bg {
            background-color: #306AE7;
        }

        .name-cell {
            max-width: 250px;
            word-wrap: break-word;
            white-space: normal;
            line-height: 1.4;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_ORIGIN = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1"
            ? "http://localhost:5001"
            : "https://sm2-learning-system.onrender.com";

        const API = `${API_ORIGIN}/api`;

        function parseLeetCodeURL(url) {
            try {
                const u = (url || "").trim();

                // ÊîØÊåÅÔºö
                // https://leetcode.com/problems/xxx/
                // https://leetcode.cn/problems/xxx/
                // http://www.leetcode.com/problems/xxx/?...
                const match = u.match(/^(https?:\/\/)?(www\.)?leetcode\.(com|cn)\/problems\/([\w-]+)/i);


                if (!match) return null;

                const slug = match[4]; // Á¨¨4‰∏™ÊçïËé∑ÁªÑÊâçÊòØÈ¢òÁõÆslug

                const name = slug
                    .split('-')
                    .filter(Boolean)
                    .map(w => w.charAt(0).toUpperCase() + w.slice(1))
                    .join(' ');

                // ‰Ω†Áé∞Âú®ÁöÑIDÈÄªËæëÔºö‰ºòÂÖàÂèñÊï∞Â≠óÈ¢òÂè∑ÔºåÂê¶ÂàôÁî®slug
                const numMatch = u.match(/\/(\d+)\//);
                const num = numMatch ? numMatch[1] : slug;

                return { name, num };
            } catch (e) {
                return null;
            }
        }



        function App() {
            const [token, setToken] = useState(localStorage.getItem('token'));
            const [user, setUser] = useState(localStorage.getItem('username'));

            if (!token) return <Login onLogin={(t, u) => { localStorage.setItem('token', t); localStorage.setItem('username', u); setToken(t); setUser(u); }} />;

            const logout = () => { localStorage.clear(); setToken(null); setUser(null); };
            return <Main user={user} token={token} onLogout={logout} />;
        }

        function Login({ onLogin }) {
            const [mode, setMode] = useState('login');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const submit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    const res = await fetch(`${API}/auth/${mode}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password })
                    });
                    const data = await res.json();
                    if (res.ok) onLogin(data.token, data.username);
                    else setError(data.error || 'Operation failed');
                } catch (e) {
                    setError('Network error');
                }
            };

            return (
                <div className="min-h-screen bg-white flex items-center justify-center">
                    <div className="bg-white border-2 border-gray-200 rounded-3xl shadow-xl p-10 w-96">
                        <div className="text-center mb-8">
                            <img src="https://raw.githubusercontent.com/jingxuezhuo/sm2-learning-system/main/frontend/static/pic.png" alt="MemoCode Logo" className="w-40 h-40 mx-auto mb-4 shadow-lg object-contain" />
                            <h1 className="text-3xl font-bold mb-2">MemoCode</h1>
                            <p className="text-gray-500">Intelligent Learning Scheduler</p>
                        </div>
                        <div className="flex mb-6 bg-gray-100 rounded-lg p-1">
                            <button onClick={() => setMode('login')} className={`flex-1 py-2 rounded-lg font-medium ${mode === 'login' ? 'bg-white shadow' : ''}`}>Login</button>
                            <button onClick={() => setMode('register')} className={`flex-1 py-2 rounded-lg font-medium ${mode === 'register' ? 'bg-white shadow' : ''}`}>Register</button>
                        </div>
                        <form onSubmit={submit} className="space-y-4">
                            <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} className="w-full border-2 rounded-lg px-4 py-3" placeholder="Username" required />
                            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full border-2 rounded-lg px-4 py-3" placeholder="Password (min 6 chars)" required minLength="6" />
                            {error && <div className="bg-red-50 p-3 rounded text-red-700 text-sm">{error}</div>}
                            <button type="submit" className="w-full primary-btn text-white py-3 rounded-lg font-medium">{mode === 'login' ? 'Login' : 'Register'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        function Main({ user, token, onLogout }) {
            const getLocalDate = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const [tab, setTab] = useState('cards-list');
            const [cards, setCards] = useState([]);
            const [filtered, setFiltered] = useState([]);
            const [due, setDue] = useState([]);
            const [date, setDate] = useState(getLocalDate());
            const [stats, setStats] = useState({ total_cards: 0, due_today: 0 });
            const [todayNewCards, setTodayNewCards] = useState(0);
            const [msg, setMsg] = useState('');


            const [tags, setTags] = useState([]);
            const [search, setSearch] = useState('');
            const [filterTags, setFilterTags] = useState([]);
            const [filterProf, setFilterProf] = useState('all');
            const [dateStart, setDateStart] = useState('');
            const [dateEnd, setDateEnd] = useState('');
            const [showAdd, setShowAdd] = useState(false);
            const [showBatch, setShowBatch] = useState(false);
            const [showNote, setShowNote] = useState(false);
            const [showHist, setShowHist] = useState(false);
            const [curr, setCurr] = useState(null);
            const [page, setPage] = useState(1);
            const perPage = 100;

            const api = async (url, opt = {}) => {
                const h = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...opt.headers };
                return fetch(`${API}${url}`, { ...opt, headers: h });
            };

            useEffect(() => {
                load();
            }, [tab, date]);






            useEffect(() => {
                filter();
            }, [cards, search, filterTags, filterProf, dateStart, dateEnd]);

            const load = async () => {
                try {


                    const r1 = await api('/stats');
                    if (r1.ok) {
                        const d1 = await r1.json();
                        setStats(d1);
                    }

                    const r2 = await api('/tags');
                    if (r2.ok) {
                        const d2 = await r2.json();
                        setTags(d2.tags || []);
                    }

                    if (tab === 'today') {
                        const r3 = await api('/cards/due', { method: 'POST', body: JSON.stringify({ date }) });
                        if (r3.ok) {
                            const d3 = await r3.json();
                            setDue(d3.cards || []);
                        }
                    } else {
                        const r4 = await api('/cards');
                        if (r4.ok) {
                            const d4 = await r4.json();
                            setCards(d4.cards || []);

                            const today = getLocalDate();
                            const newToday = d4.cards.filter(c => c.first_date === today).length;
                            setTodayNewCards(newToday);
                        }
                    }
                } catch (e) {
                    console.error('Load error:', e);
                }
            };

            const filter = () => {
                let f = [...cards];
                if (search) f = f.filter(c => c.card_id.includes(search));
                if (filterTags.length) f = f.filter(c => filterTags.some(t => c.tags?.includes(t)));
                if (filterProf !== 'all') {
                    f = f.filter(c => {
                        const s = c.ef >= 2.8 ? 5 : c.ef >= 2.5 ? 4 : c.ef >= 2.2 ? 3 : c.ef >= 1.8 ? 2 : 1;
                        return s === parseInt(filterProf);
                    });
                }
                if (dateStart) f = f.filter(c => c.first_date >= dateStart);
                if (dateEnd) f = f.filter(c => c.first_date <= dateEnd);

                f.sort((a, b) => {
                    const dateA = new Date(a.first_date);
                    const dateB = new Date(b.first_date);
                    return dateB - dateA;
                });

                setFiltered(f);
            };

            const review = async (id, score) => {
                try {
                    const res = await api('/cards/review', {
                        method: 'POST',
                        body: JSON.stringify({ card_id: id, score, review_date: date })
                    });

                    if (res.ok) {
                        const data = await res.json();
                        const nextReview = data?.card?.next_review;
                        const reviewCount = data?.card?.review_count;

                        // ‚úÖ ÂÖ≥ÈîÆÔºöÁ´ãÂàªÊää due ÈáåÁöÑËøôÂº†Âç°Ê†áËÆ∞‰∏∫‚Äú‰ªäÂ§©Â∑≤Â§ç‰π†‚ÄùÔºåÈ°µÈù¢‰ºöÈ©¨‰∏äÁßªÂä®Âà∞ Completed
                        setDue(prev =>
                            prev.map(c =>
                                c.card_id === id
                                    ? {
                                        ...c,
                                        last_review_date: date,
                                        next_review: nextReview ?? c.next_review,
                                        review_count: reviewCount ?? (c.review_count || 0) + 1
                                    }
                                    : c
                            )
                        );

                        setMsg('Review successful');
                        setTimeout(() => setMsg(''), 2000);

                        // stats ‰ªçÁÑ∂ÂèØ‰ª•Âà∑Êñ∞
                        const r1 = await api('/stats');
                        if (r1.ok) {
                            const d1 = await r1.json();
                            setStats(d1);
                        }
                    } else {
                        setMsg('Review failed');
                        setTimeout(() => setMsg(''), 2000);
                    }
                } catch (e) {
                    setMsg('Review failed');
                    setTimeout(() => setMsg(''), 2000);
                }
            };


            const add = async (id, name, score, cardTags, link) => {
                try {
                    const res = await api('/cards/add', {
                        method: 'POST',
                        body: JSON.stringify({
                            card_id: id,
                            name: name || '',
                            first_date: date,
                            score,
                            tags: cardTags || [],
                            link: link || ''
                        })
                    });
                    if (res.ok) {
                        setMsg('Added successfully');
                        setTimeout(() => setMsg(''), 2000);
                        load();
                        return true;
                    } else {
                        const data = await res.json();
                        setMsg(data.error || 'Add failed');
                        setTimeout(() => setMsg(''), 4000);
                        return false;
                    }
                } catch (e) {
                    setMsg('Network error');
                    setTimeout(() => setMsg(''), 2000);
                    return false;
                }
            };

            const batchAdd = async (items) => {
                try {
                    const res = await api('/cards/batch', {
                        method: 'POST',
                        body: JSON.stringify({ cards: items, date })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        setMsg(`Added ${data.added.length} cards, Reviewed ${data.reviewed.length} cards`);
                        setTimeout(() => setMsg(''), 3000);
                        load();
                        return true;
                    }
                } catch (e) {
                    setMsg('Batch add failed');
                    setTimeout(() => setMsg(''), 2000);
                }
                return false;
            };

            const update = async (id, upd) => {
                try {
                    const res = await api('/cards/update', { method: 'POST', body: JSON.stringify({ card_id: id, ...upd }) });
                    if (res.ok) {
                        load();
                        return true;
                    }
                    return false;
                } catch (e) {
                    return false;
                }
            };

            const del = async (id) => {
                if (!confirm('Are you sure to delete this card?')) return;
                try {
                    const res = await api(`/cards/${id}`, { method: 'DELETE' });
                    if (res.ok) {
                        setMsg('Deleted successfully');
                        setTimeout(() => setMsg(''), 2000);
                        load();
                    }
                } catch (e) {
                    setMsg('Delete failed');
                    setTimeout(() => setMsg(''), 2000);
                }
            };

            const start = (page - 1) * perPage;
            const current = filtered.slice(start, start + perPage);
            const totalPages = Math.ceil(filtered.length / perPage);

            const sortedDue = [...due].sort((a, b) => {
                const aDone = a.last_review_date === date;
                const bDone = b.last_review_date === date;
                if (aDone && !bDone) return 1;
                if (!aDone && bDone) return -1;
                return 0;
            });
            const reviewedTodayCount = due.filter(c => c.last_review_date === date).length;
            // ËÆ°ÁÆóÂæÖÂ§ç‰π†ÂíåÂ∑≤Â§ç‰π†ÁöÑÊï∞Èáè
            const pendingCount = due.filter(c => c.last_review_date !== date).length;
            const completedCount = due.filter(c => c.last_review_date === date).length;


            return (
                <div className="min-h-screen bg-gray-50">
                    {msg && <div className="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">{msg}</div>}

                    <div className="bg-white shadow">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between">
                            <div className="flex items-center space-x-4">
                                <img src="https://raw.githubusercontent.com/jingxuezhuo/sm2-learning-system/main/frontend/static/pic.png" alt="MemoCode" className="w-20 h-20 shadow-lg object-contain" />

                                <div>
                                    <h1 className="text-xl font-bold">MemoCode</h1>
                                    <p className="text-xs text-gray-500">Intelligent Learning Scheduler</p>
                                </div>
                            </div>
                            <div className="flex items-center space-x-6">
                                <div className="text-center">
                                    <div className="text-sm text-gray-500">Today's New Cards</div>
                                    <div className="text-xl font-bold text-green-600">{todayNewCards}</div>
                                </div>
                                <div className="text-center">
                                    <div className="text-sm text-gray-500">Today's Review</div>
                                    <div className="text-xl font-bold">
                                        <span className="text-green-600">{completedCount}</span>/
                                        <span className="primary-text">{pendingCount}</span>
                                    </div>
                                </div>

                                <div className="text-center">
                                    <div className="text-sm text-gray-500">Total Cards</div>
                                    <div className="text-xl font-bold primary-text">{stats.total_cards || 0}</div>
                                </div>
                                <div className="flex items-center space-x-2">
                                    <span className="text-gray-600">{user}</span>
                                    <button onClick={onLogout} className="text-sm text-red-500 hover:text-red-700">Logout</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-6 py-8">
                        <div className="bg-white rounded-t-xl shadow border-b">
                            <div className="flex justify-between items-center w-full">
                                <div className="flex">
                                    <button onClick={() => setTab('cards-list')} className={`px-8 py-4 font-semibold ${tab === 'cards-list' ? 'primary-text border-b-4' : 'text-gray-500'}`} style={tab === 'cards-list' ? { borderColor: '#306AE7' } : {}}>Cards List</button>
                                    <button onClick={() => setTab('today')} className={`px-8 py-4 font-semibold ${tab === 'today' ? 'primary-text border-b-4' : 'text-gray-500'}`} style={tab === 'today' ? { borderColor: '#306AE7' } : {}}>Today's Review</button>
                                    <button onClick={() => setTab('journey')} className={`px-8 py-4 font-semibold ${tab === 'journey' ? 'primary-text border-b-4' : 'text-gray-500'}`} style={tab === 'journey' ? { borderColor: '#306AE7' } : {}}>Your Study Journey</button>
                                </div>
                                <button onClick={() => window.open('https://docs.google.com/spreadsheets/d/1X-ZjRgFnvAt-WRole1yuXiTeEZwcgao2LiPH0yshCBg/edit?usp=sharing', '_blank')} className="px-4 py-2 mr-4 text-sm bg-blue-50 text-blue-600 hover:bg-blue-100 rounded-lg flex items-center space-x-2 border border-blue-200">
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    <span className="font-medium">Instructions</span>
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-b-xl shadow-lg p-8">
                            {tab === 'today' ? (
                                <TodayView date={date} setDate={setDate} due={sortedDue} review={review} setShowBatch={setShowBatch} update={update} setCurr={setCurr} setShowNote={setShowNote} />

                            ) : tab === 'journey' ? (
                                <StudyJourney cards={cards} setCurr={setCurr} setShowNote={setShowNote} setShowHist={setShowHist} del={del} update={update} allTags={tags} />
                            ) : (
                                <Library cards={current} total={filtered.length} page={page} setPage={setPage} totalPages={totalPages} setShowAdd={setShowAdd} update={update} del={del} search={search} setSearch={setSearch} filterTags={filterTags} setFilterTags={setFilterTags} filterProf={filterProf} setFilterProf={setFilterProf} dateStart={dateStart} setDateStart={setDateStart} dateEnd={dateEnd} setDateEnd={setDateEnd} tags={tags} allTags={tags} setCurr={setCurr} setShowNote={setShowNote} setShowHist={setShowHist} />
                            )}
                        </div>
                    </div>

                    {showAdd && <AddModal date={date} setDate={setDate} onAdd={add} onClose={() => setShowAdd(false)} allTags={tags} />}
                    {showBatch && <BatchModal date={date} setDate={setDate} onAdd={batchAdd} onClose={() => setShowBatch(false)} />}
                    {showNote && curr && <NoteEditor card={curr} token={token} onSave={(note) => { update(curr.card_id, { note }); setShowNote(false); setCurr(null); setMsg('Note saved'); setTimeout(() => setMsg(''), 2000); }} onClose={() => { setShowNote(false); setCurr(null); }} />}
                    {showHist && curr && <HistModal card={curr} onClose={() => { setShowHist(false); setCurr(null); }} />}
                </div>
            );
        }

        function TodayView({ date, setDate, due, review, setShowBatch, update, setCurr, setShowNote }) {
            const pendingCards = due.filter(c => c.last_review_date !== date);
            const completedCards = due.filter(c => c.last_review_date === date);


            return (
                <>
                    <div className="mb-8 flex justify-between">
                        <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="border-2 rounded-lg px-4 py-2" />
                        <button onClick={() => setShowBatch(true)} className="primary-btn text-white px-6 py-3 rounded-lg">+ Add Card</button>
                    </div>

                    {pendingCards.length === 0 && completedCards.length === 0 ? (
                        <div className="text-center py-20"><div className="text-6xl mb-4">üéâ</div><p className="text-2xl text-gray-600">No cards to review today!</p></div>
                    ) : (
                        <>
                            {pendingCards.length > 0 && (
                                <div className="mb-12">
                                    <h3 className="text-xl font-bold mb-4 primary-text">Ready for Review - {pendingCards.length} cards</h3>
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left font-semibold">Done</th>
                                                <th className="px-4 py-3 text-left font-semibold">Stars</th>
                                                <th className="px-4 py-3 text-left font-semibold">ID</th>
                                                <th className="px-4 py-3 text-left font-semibold">Name</th>
                                                <th className="px-4 py-3 text-left font-semibold">Tags</th>
                                                <th className="px-4 py-3 text-left font-semibold">Link</th>
                                                <th className="px-4 py-3 text-left font-semibold">Rate to Complete Review</th>
                                                <th className="px-4 py-3 text-left font-semibold">Review Count</th>
                                                <th className="px-4 py-3 text-left font-semibold">Note</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {pendingCards.map((c, i) => {
                                                const s = c.ef >= 2.8 ? 5 : c.ef >= 2.5 ? 4 : c.ef >= 2.2 ? 3 : c.ef >= 1.8 ? 2 : 1;
                                                return (
                                                    <tr key={i} className="hover:bg-blue-50 border-t">
                                                        <td className="px-4 py-3"></td>
                                                        <td className="px-4 py-3 text-sm">{'‚≠ê'.repeat(s)}</td>
                                                        <td className="px-4 py-3 font-bold">{c.card_id}</td>
                                                        <td className="px-4 py-3 name-cell"><EditField val={c.name} save={(v) => update(c.card_id, { name: v })} placeholder="Add name" /></td>
                                                        <td className="px-4 py-3"><Tags tags={c.tags || []} save={(t) => update(c.card_id, { tags: t })} /></td>
                                                        <td className="px-4 py-3">{c.link ? <a href={c.link} target="_blank" className="primary-text text-sm hover:underline">Open</a> : <span className="text-gray-400 text-sm">-</span>}</td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex space-x-2">
                                                                {[1, 2, 3, 4, 5].map(n => (
                                                                    <button key={n} onClick={() => review(c.card_id, n)} className="w-10 h-10 border-2 rounded font-bold hover:text-white" style={{ borderColor: '#306AE7' }} onMouseEnter={(e) => (e.target.style.backgroundColor = '#306AE7')} onMouseLeave={(e) => (e.target.style.backgroundColor = 'white')}>{n}</button>
                                                                ))}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">{c.review_count || 0} times</td>
                                                        <td className="px-4 py-3"><button onClick={() => { setCurr(c); setShowNote(true); }} className="primary-text text-sm hover:underline">{c.note ? 'View' : 'Add'}</button></td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}

                            {completedCards.length > 0 && (
                                <div>
                                    <h3 className="text-xl font-bold mb-4 text-green-600">Review Completed - {completedCards.length} cards</h3>
                                    <table className="w-full">
                                        <thead className="bg-gray-50">
                                            <tr>
                                                <th className="px-4 py-3 text-left font-semibold">Done</th>
                                                <th className="px-4 py-3 text-left font-semibold">Stars</th>
                                                <th className="px-4 py-3 text-left font-semibold">ID</th>
                                                <th className="px-4 py-3 text-left font-semibold">Name</th>
                                                <th className="px-4 py-3 text-left font-semibold">Tags</th>
                                                <th className="px-4 py-3 text-left font-semibold">Link</th>
                                                <th className="px-4 py-3 text-left font-semibold">Review Count</th>
                                                <th className="px-4 py-3 text-left font-semibold">Note</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {completedCards.map((c, i) => {
                                                const s = c.ef >= 2.8 ? 5 : c.ef >= 2.5 ? 4 : c.ef >= 2.2 ? 3 : c.ef >= 1.8 ? 2 : 1;
                                                return (
                                                    <tr key={i} className="bg-green-50 opacity-70 border-t">
                                                        <td className="px-4 py-3"><span className="text-green-600 text-xl">‚úì</span></td>
                                                        <td className="px-4 py-3 text-sm">{'‚≠ê'.repeat(s)}</td>
                                                        <td className="px-4 py-3 font-bold text-gray-600">{c.card_id}</td>
                                                        <td className="px-4 py-3 name-cell text-gray-600">{c.name || '-'}</td>
                                                        <td className="px-4 py-3">
                                                            <div className="flex flex-wrap gap-1">
                                                                {(c.tags || []).map(t => <span key={t} className="px-2 py-1 rounded-full text-xs" style={{ backgroundColor: '#E8EFFD', color: '#306AE7' }}>{t}</span>)}
                                                            </div>
                                                        </td>
                                                        <td className="px-4 py-3">{c.link ? <a href={c.link} target="_blank" className="primary-text text-sm hover:underline">Open</a> : <span className="text-gray-400 text-sm">-</span>}</td>
                                                        <td className="px-4 py-3 text-sm text-gray-600">{c.review_count || 0} times</td>
                                                        <td className="px-4 py-3"><button onClick={() => { setCurr(c); setShowNote(true); }} className="primary-text text-sm hover:underline">{c.note ? 'View' : 'Add'}</button></td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </>
                    )}
                </>
            );
        }

        function StudyJourney({ cards, setCurr, setShowNote, setShowHist, del, update, allTags }) {
            const [filterMode, setFilterMode] = useState('most-reviewed');
            const [filteredCards, setFilteredCards] = useState([]);
            const [page, setPage] = useState(1);
            const [menu, setMenu] = useState(null);
            const perPage = 100;

            useEffect(() => {
                filterCards();
            }, [cards, filterMode]);

            const filterCards = () => {
                let result = [...cards];

                const threeMonthsLater = new Date();
                threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
                const masteredThreshold = threeMonthsLater.toISOString().split('T')[0];
                result = result.filter(c => !c.next_review || c.next_review < masteredThreshold);

                if (filterMode === 'most-reviewed') {
                    result.sort((a, b) => (b.review_count || 0) - (a.review_count || 0));
                }

                setFilteredCards(result);
                setPage(1);
            };

            const totalCards = cards.filter(c => {
                const threeMonthsLater = new Date();
                threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
                const masteredThreshold = threeMonthsLater.toISOString().split('T')[0];
                return !c.next_review || c.next_review < masteredThreshold;
            }).length;
            const totalReviews = cards.reduce((sum, c) => sum + (c.review_count || 0), 0);



            const start = (page - 1) * perPage;
            const currentCards = filteredCards.slice(start, start + perPage);
            const totalPages = Math.ceil(filteredCards.length / perPage);

            const getActivityData = () => {
                const activities = {};
                cards.forEach(card => {
                    if (card.first_date) {
                        activities[card.first_date] = (activities[card.first_date] || 0) + 1;
                    }
                    if (card.last_review_date && card.last_review_date !== card.first_date) {
                        const count = card.review_count || 0;
                        if (count > 1) {
                            activities[card.last_review_date] = (activities[card.last_review_date] || 0) + (count - 1);
                        }
                    }
                });
                return activities;
            };

            const activities = getActivityData();
            const getColor = (count, inCurrentYear) => {
                if (!inCurrentYear) return '#ebedf0';
                if (count === 0) return '#ebedf0';
                if (count <= 2) return '#9be9a8';
                if (count <= 5) return '#40c463';
                if (count <= 10) return '#30a14e';
                if (count <= 20) return '#216e39';
                return '#0d4429';
            };

            // ====== 1) ÁîüÊàê GitHub È£éÊ†ºÁöÑ weeksÔºàÊØèÂàó=‰∏ÄÂë®Ôºå7Ë°åÔºâÔºåÂπ∂ÂéªÊéâÂπ¥Â§ñ‚ÄúÈáçÂ§çÂ§©Êï∞Ê†ºÂ≠ê‚Äù ======
            const buildWeeksOfYear = () => {
                const today = new Date();
                const year = today.getFullYear();

                const yearStart = new Date(year, 0, 1);   // Jan 1
                const yearEnd = new Date(year, 11, 31);   // Dec 31

                // ÊâæÂà∞ÂåÖÂê´ Jan1 ÁöÑÈÇ£‰∏ÄÂë®ÁöÑ‚ÄúÂë®Êó•‚Äù
                const firstSunday = new Date(yearStart);
                firstSunday.setDate(yearStart.getDate() - yearStart.getDay()); // Sun=0

                // ÊâæÂà∞ÂåÖÂê´ Dec31 ÁöÑÈÇ£‰∏ÄÂë®ÁöÑ‚ÄúÂë®ÂÖ≠‚Äù
                const lastSaturday = new Date(yearEnd);
                lastSaturday.setDate(yearEnd.getDate() + (6 - yearEnd.getDay()));

                const totalWeeks =
                    Math.floor((lastSaturday - firstSunday) / (7 * 24 * 60 * 60 * 1000)) + 1;

                // ÊØèÂàóÂõ∫ÂÆö 7 ‰∏™‰ΩçÁΩÆÔºàSun..SatÔºâÔºåÂπ¥Â§ñ padding Áî® null Âç†‰ΩçÔºàÂêéÈù¢Ê∏≤ÊüìÊó∂‚ÄúÂà†Èô§Ê†ºÂ≠ê‚ÄùÔºâ
                const weeks = Array.from({ length: totalWeeks }, () => ({
                    days: Array(7).fill(null)
                }));

                // Â°´ÂÖÖÂπ¥ÂÜÖÊØè‰∏ÄÂ§©
                for (let d = new Date(yearStart); d <= yearEnd; d.setDate(d.getDate() + 1)) {
                    const dateObj = new Date(d);
                    const weekIndex = Math.floor((dateObj - firstSunday) / (7 * 24 * 60 * 60 * 1000));
                    const dow = dateObj.getDay(); // 0..6

                    const dateStr = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                    const count = activities[dateStr] || 0;

                    weeks[weekIndex].days[dow] = {
                        date: dateStr,
                        count,
                        day: dow,
                        month: dateObj.getMonth(),
                        year: dateObj.getFullYear(),
                        inCurrentYear: true
                    };
                }

                // ‚úÖ monthBreakÔºöÂΩìÊú¨ÂàóÁ¨¨‰∏Ä‰∏™‚ÄúÂπ¥ÂÜÖÂ§©‚ÄùÁöÑÊúà‰ªΩ != ‰∏ä‰∏ÄÂàóÊúà‰ªΩÊó∂ÔºåÊèíÂÖ•Á©∫Èöô
                let prevMonth = null;
                const weeksWithBreak = weeks.map((w) => {
                    const firstValidDay = w.days.find(x => x && x.inCurrentYear);
                    const weekMonth = firstValidDay ? firstValidDay.month : prevMonth;

                    const monthBreak =
                        prevMonth !== null &&
                        weekMonth !== null &&
                        weekMonth !== prevMonth;

                    prevMonth = weekMonth;
                    return { ...w, monthBreak, weekMonth };
                });

                return weeksWithBreak;
            };

            const weeksWithBreak = buildWeeksOfYear();

            // ‚úÖ monthLabelsÔºöÊØè‰∏™ÊúàÁ¨¨‰∏ÄÊ¨°Âá∫Áé∞ÁöÑ weekIndexÔºàÁî®‰∫éÊúà‰ªΩÊñáÂ≠óÂØπÈΩêÔºâ
            const monthLabels = [];
            const seenMonth = new Set();
            weeksWithBreak.forEach((w, wi) => {
                const m = w.weekMonth;
                if (m === null || m === undefined) return;
                if (!seenMonth.has(m)) {
                    seenMonth.add(m);
                    monthLabels.push({ month: m, weekIndex: wi });
                }
            });

            // ====== 2) ËÆ°ÁÆóÊØèÂàó week ÁöÑÁúüÂÆû x ÂùêÊ†áÔºàÊää monthBreak Á©∫Èöô‰πüÁÆóËøõÂéªÔºâ ======
            const CELL = 12;   // w-3
            const GAP = 4;     // gap-x-1
            const BREAK = 12;  // monthBreak Áî® w-3

            const weekX = (() => {
                let x = 0;
                const arr = [];
                for (let wi = 0; wi < weeksWithBreak.length; wi++) {
                    const w = weeksWithBreak[wi];
                    if (w.monthBreak) x += BREAK + GAP;
                    arr[wi] = x;
                    x += CELL + GAP;
                }
                return arr;
            })();






            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];


            return (
                <div>
                    <div className="grid grid-cols-2 gap-6 mb-8">
                        <div className="bg-white border-2 rounded-xl p-6 text-center shadow-sm">
                            <div className="text-4xl font-bold text-blue-600 mb-2">{totalCards}</div>
                            <div className="text-sm text-gray-500">Total Questions Solved: {totalCards}</div>
                        </div>
                        <div className="bg-white border-2 rounded-xl p-6 text-center shadow-sm">
                            <div className="text-4xl font-bold text-purple-600 mb-2">{totalReviews}</div>
                            <div className="text-sm text-gray-500">Total Reviews: {totalReviews}</div>
                        </div>
                    </div>

                    <div className="bg-white border-2 rounded-xl p-6 mb-8 shadow-sm overflow-x-auto">
                        <div className="flex gap-x-1 pb-4 min-w-max">
                            {weeksWithBreak.map((week, wi) => (
                                <React.Fragment key={wi}>
                                    {/* Êúà‰ªΩÂàáÊç¢Á©∫Èöô */}
                                    {week.monthBreak && <div className="w-3"></div>}

                                    <div className="flex flex-col gap-y-1">
                                        {week.days.map((day, di) => {
                                            // Âπ¥Â§ñ paddingÔºö‰∏çÁîªÊ†ºÂ≠êÔºå‰ΩÜ‰øùÁïôÈ´òÂ∫¶
                                            if (!day) {
                                                // ‚úÖ ÁúüÊ≠£‚ÄúÈöêËóè‰ΩÜÂç†‰Ωç‚ÄùÔºö‰∏çÊòæÁ§∫Ôºå‰ΩÜ‰øùÁïôÊ†ºÂ≠ê‰ΩçÁΩÆÁî®‰∫éÂØπÈΩê
                                                return <div key={di} className="w-3 h-3 invisible pointer-events-none" aria-hidden="true" />;
                                            }


                                            return (
                                                <div
                                                    key={di}
                                                    className="w-3 h-3 rounded-sm cursor-pointer hover:ring-2 hover:ring-blue-400 transition-all"
                                                    style={{ backgroundColor: getColor(day.count, true) }}
                                                    title={`${day.date}: ${day.count} activities`}
                                                />
                                            );
                                        })}
                                    </div>
                                </React.Fragment>
                            ))}
                        </div>

                        {/* Month labels (GitHub-style aligned to columns) */}
                        <div className="relative mt-4 h-4 min-w-max">
                            {monthLabels.map(({ month, weekIndex }) => (
                                <span
                                    key={month}
                                    className="absolute text-xs text-gray-400"
                                    style={{ left: weekX[weekIndex] }}
                                >
                                    {months[month]}
                                </span>
                            ))}
                        </div>

                    </div>

                    <div className="flex space-x-4 mb-6">
                        <button onClick={() => setFilterMode('most-reviewed')} className={`px-6 py-3 rounded-lg font-medium border-2 ${filterMode === 'most-reviewed' ? 'primary-bg text-white border-blue-600' : 'bg-white text-gray-600 border-gray-200'}`}>Most Reviewed First</button>
                    </div>

                    <div className="mb-4 text-sm text-gray-600">Total: <span className="font-bold primary-text">{filteredCards.length}</span> cards</div>

                    <table className="w-full mb-8">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-4 py-3 text-left font-semibold">Stars</th>
                                <th className="px-4 py-3 text-left font-semibold">ID</th>
                                <th className="px-4 py-3 text-left font-semibold">Name</th>
                                <th className="px-4 py-3 text-left font-semibold">Tags</th>
                                <th className="px-4 py-3 text-left font-semibold">Last Completed</th>
                                <th className="px-4 py-3 text-left font-semibold">Next Review</th>
                                <th className="px-4 py-3 text-left font-semibold">Review Count</th>
                                <th className="px-4 py-3 text-left font-semibold">Link</th>
                                <th className="px-4 py-3 text-left font-semibold">Note</th>
                                <th className="px-4 py-3 text-left font-semibold">More</th>
                            </tr>
                        </thead>
                        <tbody>
                            {currentCards.length === 0 ? (
                                <tr><td colSpan="10" className="text-center py-20 text-gray-400">No data</td></tr>
                            ) : (
                                currentCards.map((c, i) => {
                                    const s = c.ef >= 2.8 ? 5 : c.ef >= 2.5 ? 4 : c.ef >= 2.2 ? 3 : c.ef >= 1.8 ? 2 : 1;
                                    return (
                                        <tr key={i} className="border-t hover:bg-blue-50">
                                            <td className="px-4 py-3 text-sm">{'‚≠ê'.repeat(s)}</td>
                                            <td className="px-4 py-3 font-bold">{c.card_id}</td>
                                            <td className="px-4 py-3 name-cell">{c.name || '-'}</td>
                                            <td className="px-4 py-3">
                                                <div className="flex flex-wrap gap-1">
                                                    {(c.tags || []).map(t => <span key={t} className="px-2 py-1 rounded-full text-xs" style={{ backgroundColor: '#E8EFFD', color: '#306AE7' }}>{t}</span>)}
                                                </div>
                                            </td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.last_review_date || c.first_date}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.next_review || '-'}</td>
                                            <td className="px-4 py-3 text-center"><span className="inline-block bg-gray-100 px-3 py-1 rounded-full text-sm font-medium">{c.review_count || 0}</span></td>
                                            <td className="px-4 py-3">{c.link ? <a href={c.link} target="_blank" className="primary-text text-sm hover:underline">Open</a> : <span className="text-gray-400 text-sm">-</span>}</td>
                                            <td className="px-4 py-3"><button onClick={() => { setCurr(c); setShowNote(true); }} className="primary-text text-sm hover:underline">{c.note ? 'View' : 'Add'}</button></td>
                                            <td className="px-4 py-3 relative">
                                                <button onClick={() => setMenu(menu === i ? null : i)} className="text-gray-600 text-sm px-3 py-1 border rounded hover:bg-gray-50">More</button>
                                                {menu === i && (
                                                    <div className="absolute right-0 mt-1 bg-white border-2 shadow-lg rounded z-10 w-36">
                                                        <button onClick={() => { setCurr(c); setShowHist(true); setMenu(null); }} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">View History</button>
                                                        <button onClick={() => { del(c.card_id); setMenu(null); }} className="block w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 text-sm">Delete</button>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>

                    {totalPages > 1 && (
                        <div className="flex justify-center space-x-2">
                            <button onClick={() => setPage(Math.max(1, page - 1))} disabled={page === 1} className={`px-4 py-2 border-2 rounded ${page === 1 ? 'opacity-50' : ''}`}>‚Üê</button>
                            {Array.from({ length: Math.min(5, totalPages) }, (_, i) => i + 1).map(p => (
                                <button key={p} onClick={() => setPage(p)} className={`px-4 py-2 rounded ${page === p ? 'primary-btn text-white' : 'border-2'}`}>{p}</button>
                            ))}
                            <button onClick={() => setPage(Math.min(totalPages, page + 1))} disabled={page === totalPages} className={`px-4 py-2 border-2 rounded ${page === totalPages ? 'opacity-50' : ''}`}>‚Üí</button>
                        </div>
                    )}
                </div>
            );
        }

        function Library({ cards, total, page, setPage, totalPages, setShowAdd, update, del, search, setSearch, filterTags, setFilterTags, filterProf, setFilterProf, dateStart, setDateStart, dateEnd, setDateEnd, tags, allTags, setCurr, setShowNote, setShowHist }) {
            const [showTags, setShowTags] = useState(false);
            const [menu, setMenu] = useState(null);

            return (
                <>
                    <div className="mb-6 bg-gray-50 border-2 rounded-xl p-6 pb-20 relative">
                        <div className="grid grid-cols-4 gap-4">
                            <div><label className="block text-sm mb-2 font-medium">Problem ID</label><input value={search} onChange={(e) => setSearch(e.target.value)} className="w-full border-2 rounded px-4 py-2" placeholder="Search..." /></div>
                            <div className="relative">
                                <label className="block text-sm mb-2 font-medium">Tags</label>
                                <button onClick={() => setShowTags(!showTags)} className="w-full border-2 rounded px-4 py-2 bg-white flex justify-between">
                                    <span className="truncate">{filterTags.length ? `${filterTags.length} selected` : 'Select'}</span><span>‚ñº</span>
                                </button>
                                {showTags && (
                                    <div className="absolute z-10 mt-1 w-full bg-white border-2 rounded shadow-lg max-h-64 overflow-y-auto">
                                        <div onClick={() => setFilterTags(filterTags.length === tags.length ? [] : [...tags])} className="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b bg-gray-50">
                                            <input type="checkbox" checked={filterTags.length === tags.length && tags.length > 0} readOnly className="mr-2" />Select All
                                        </div>
                                        {tags.length === 0 ? (
                                            <div className="px-4 py-2 text-gray-400 text-sm">No tags</div>
                                        ) : (
                                            tags.map(t => (
                                                <div key={t} onClick={() => setFilterTags(filterTags.includes(t) ? filterTags.filter(x => x !== t) : [...filterTags, t])} className="px-4 py-2 hover:bg-blue-50 cursor-pointer">
                                                    <input type="checkbox" checked={filterTags.includes(t)} readOnly className="mr-2" />{t}
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                            </div>
                            <div><label className="block text-sm mb-2 font-medium">Proficiency</label>
                                <select value={filterProf} onChange={(e) => setFilterProf(e.target.value)} className="w-full border-2 rounded px-3 py-2 text-sm">
                                    <option value="all">All</option>
                                    {[5, 4, 3, 2, 1].map(n => <option key={n} value={n}>{n} Star{n > 1 ? 's' : ''}</option>)}
                                </select>
                            </div>
                            <div><label className="block text-sm mb-2 font-medium">Date Range</label>
                                <div className="flex space-x-2">
                                    <input type="date" value={dateStart} onChange={(e) => setDateStart(e.target.value)} className="w-1/2 border-2 rounded px-2 py-2 text-sm" />
                                    <input type="date" value={dateEnd} onChange={(e) => setDateEnd(e.target.value)} className="w-1/2 border-2 rounded px-2 py-2 text-sm" />
                                </div>
                            </div>
                        </div>
                        <div className="absolute bottom-6 right-6">
                            <button onClick={() => setShowAdd(true)} className="primary-btn text-white px-6 py-3 rounded-lg font-medium">+ Add Card</button>
                        </div>
                    </div>

                    <div className="mb-4 text-sm text-gray-600">Total: <span className="font-bold primary-text">{total}</span> cards</div>

                    <table className="w-full mb-8">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-4 py-3 text-left font-semibold">Stars</th>
                                <th className="px-4 py-3 text-left font-semibold">ID</th>
                                <th className="px-4 py-3 text-left font-semibold">Name</th>
                                <th className="px-4 py-3 text-left font-semibold">Tags</th>
                                <th className="px-4 py-3 text-left font-semibold">Last Completed</th>
                                <th className="px-4 py-3 text-left font-semibold">Next Review</th>
                                <th className="px-4 py-3 text-left font-semibold">Review Count</th>
                                <th className="px-4 py-3 text-left font-semibold">Link</th>
                                <th className="px-4 py-3 text-left font-semibold">Note</th>
                                <th className="px-4 py-3 text-left font-semibold">More</th>
                            </tr>
                        </thead>
                        <tbody>
                            {cards.length === 0 ? (
                                <tr><td colSpan="10" className="text-center py-20 text-gray-400">No data</td></tr>
                            ) : (
                                cards.map((c, i) => {
                                    const s = c.ef >= 2.8 ? 5 : c.ef >= 2.5 ? 4 : c.ef >= 2.2 ? 3 : c.ef >= 1.8 ? 2 : 1;
                                    return (
                                        <tr key={i} className="border-t hover:bg-blue-50">
                                            <td className="px-4 py-3 text-sm">{'‚≠ê'.repeat(s)}</td>
                                            <td className="px-4 py-3 font-bold"><EditField val={c.card_id} save={(v) => update(c.card_id, { new_card_id: v })} placeholder="ID" /></td>
                                            <td className="px-4 py-3 name-cell"><EditField val={c.name} save={(v) => update(c.card_id, { name: v })} placeholder="Name" /></td>
                                            <td className="px-4 py-3"><TagsWithDropdown tags={c.tags || []} allTags={allTags} save={(t) => update(c.card_id, { tags: t })} /></td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.last_review_date || c.first_date}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.next_review || '-'}</td>
                                            <td className="px-4 py-3 text-sm text-gray-600">{c.review_count || 0}</td>
                                            <td className="px-4 py-3">{c.link ? <a href={c.link} target="_blank" className="primary-text text-sm hover:underline">Open</a> : <span className="text-gray-400 text-sm">-</span>}</td>
                                            <td className="px-4 py-3"><button onClick={() => { setCurr(c); setShowNote(true); }} className="primary-text text-sm hover:underline">{c.note ? 'View' : 'Add'}</button></td>
                                            <td className="px-4 py-3 relative">
                                                <button onClick={() => setMenu(menu === i ? null : i)} className="text-gray-600 text-sm px-3 py-1 border rounded hover:bg-gray-50">More</button>
                                                {menu === i && (
                                                    <div className="absolute right-0 mt-1 bg-white border-2 shadow-lg rounded z-10 w-36">
                                                        <button onClick={() => { setCurr(c); setShowHist(true); setMenu(null); }} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm">View History</button>
                                                        <button onClick={() => { del(c.card_id); setMenu(null); }} className="block w-full text-left px-4 py-2 hover:bg-red-50 text-red-600 text-sm">Delete</button>
                                                    </div>
                                                )}
                                            </td>
                                        </tr>
                                    );
                                })
                            )}
                        </tbody>
                    </table>

                    {totalPages > 1 && (
                        <div className="flex justify-center space-x-2">
                            <button onClick={() => setPage(Math.max(1, page - 1))} disabled={page === 1} className={`px-4 py-2 border-2 rounded ${page === 1 ? 'opacity-50' : ''}`}>‚Üê</button>
                            {Array.from({ length: Math.min(5, totalPages) }, (_, i) => i + 1).map(p => (
                                <button key={p} onClick={() => setPage(p)} className={`px-4 py-2 rounded ${page === p ? 'primary-btn text-white' : 'border-2'}`}>{p}</button>
                            ))}
                            <button onClick={() => setPage(Math.min(totalPages, page + 1))} disabled={page === totalPages} className={`px-4 py-2 border-2 rounded ${page === totalPages ? 'opacity-50' : ''}`}>‚Üí</button>
                        </div>
                    )}
                </>
            );
        }

        function EditField({ val, save, placeholder }) {
            const [edit, setEdit] = useState(false);
            const [text, setText] = useState(val || '');

            useEffect(() => {
                setText(val || '');
            }, [val]);

            if (edit) return <input value={text} onChange={(e) => setText(e.target.value)} onBlur={() => { if (text !== val) save(text); setEdit(false); }} onKeyPress={(e) => e.key === 'Enter' && setEdit(false)} className="border rounded px-2 py-1 text-sm w-full" autoFocus />;
            return <div onClick={() => setEdit(true)} className="cursor-pointer hover:bg-gray-100 px-2 py-1 rounded truncate">{val || <span className="text-gray-400 text-sm">{placeholder}</span>}</div>;
        }

        function Tags({ tags, save }) {
            const [edit, setEdit] = useState(false);
            const [tag, setTag] = useState('');
            return (
                <div className="flex flex-wrap gap-1">
                    {tags.map(t => <span key={t} className="px-2 py-1 rounded-full text-xs" style={{ backgroundColor: '#E8EFFD', color: '#306AE7' }}>{t}<button onClick={() => save(tags.filter(x => x !== t))} className="ml-1 hover:text-red-600">√ó</button></span>)}
                    {edit ? <input value={tag} onChange={(e) => setTag(e.target.value)} onBlur={() => { if (tag.trim()) save([...tags, tag.trim()]); setEdit(false); setTag(''); }} onKeyPress={(e) => e.key === 'Enter' && tag.trim() && (save([...tags, tag.trim()]), setEdit(false), setTag(''))} className="border rounded px-2 py-1 text-xs w-20" autoFocus placeholder="Tag..." /> : <button onClick={() => setEdit(true)} className="primary-text text-xs hover:underline">+ Add</button>}
                </div>
            );
        }

        function TagsWithDropdown({ tags, allTags, save }) {
            const [showDropdown, setShowDropdown] = useState(false);
            const [edit, setEdit] = useState(false);
            const [newTag, setNewTag] = useState('');

            const addExisting = (tag) => {
                if (!tags.includes(tag)) {
                    save([...tags, tag]);
                }
            };

            return (
                <div className="relative">
                    <div className="flex flex-wrap gap-1">
                        {tags.map(t => <span key={t} className="px-2 py-1 rounded-full text-xs" style={{ backgroundColor: '#E8EFFD', color: '#306AE7' }}>{t}<button onClick={() => save(tags.filter(x => x !== t))} className="ml-1 hover:text-red-600">√ó</button></span>)}
                        {edit ? (
                            <input value={newTag} onChange={(e) => setNewTag(e.target.value)} onBlur={() => { if (newTag.trim()) save([...tags, newTag.trim()]); setEdit(false); setNewTag(''); }} onKeyPress={(e) => e.key === 'Enter' && newTag.trim() && (save([...tags, newTag.trim()]), setEdit(false), setNewTag(''))} className="border rounded px-2 py-1 text-xs w-20" autoFocus placeholder="New..." />
                        ) : (
                            <button onClick={() => setShowDropdown(!showDropdown)} className="primary-text text-xs hover:underline">+ Add</button>
                        )}
                    </div>
                    {showDropdown && (
                        <div className="absolute z-20 mt-1 bg-white border-2 rounded shadow-lg w-48 max-h-48 overflow-y-auto">
                            <button onClick={() => { setShowDropdown(false); setEdit(true); }} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm primary-text">+ New Tag</button>
                            <div className="border-t"></div>
                            {allTags.filter(t => !tags.includes(t)).map(t => (
                                <button key={t} onClick={() => { addExisting(t); setShowDropdown(false); }} className="block w-full text-left px-4 py-2 hover:bg-blue-50 text-sm">{t}</button>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function TagsInput({ tags, setTags, allTags }) {
            const [showDropdown, setShowDropdown] = useState(false);
            const [newTag, setNewTag] = useState('');
            const [showNewInput, setShowNewInput] = useState(false);

            const removeTag = (tagToRemove) => {
                setTags(tags.filter(t => t !== tagToRemove));
            };

            const addExistingTag = (tag) => {
                if (!tags.includes(tag)) {
                    setTags([...tags, tag]);
                }
                setShowDropdown(false);
            };

            const addNewTag = () => {
                if (newTag.trim() && !tags.includes(newTag.trim())) {
                    setTags([...tags, newTag.trim()]);
                    setNewTag('');
                    setShowNewInput(false);
                }
            };

            return (
                <div className="relative">
                    <div className="min-h-[44px] border-2 rounded px-4 py-2 flex flex-wrap gap-2 items-center">
                        {tags.map(t => (
                            <span key={t} className="px-3 py-1 rounded-full text-sm" style={{ backgroundColor: '#E8EFFD', color: '#306AE7' }}>
                                {t}
                                <button type="button" onClick={() => removeTag(t)} className="ml-2 hover:text-red-600">√ó</button>
                            </span>
                        ))}
                        {showNewInput ? (
                            <input type="text" value={newTag} onChange={(e) => setNewTag(e.target.value)} onBlur={() => { if (newTag.trim()) addNewTag(); else setShowNewInput(false); }} onKeyPress={(e) => e.key === 'Enter' && (e.preventDefault(), addNewTag())} className="border rounded px-2 py-1 text-sm w-32" placeholder="New tag..." autoFocus />
                        ) : (
                            <button type="button" onClick={() => setShowDropdown(!showDropdown)} className="primary-text text-sm hover:underline">+ Add Tag</button>
                        )}
                    </div>
                    {showDropdown && (
                        <div className="absolute z-30 mt-1 w-full bg-white border-2 rounded shadow-lg max-h-48 overflow-y-auto">
                            <button type="button" onClick={() => { setShowDropdown(false); setShowNewInput(true); }} className="block w-full text-left px-4 py-2 hover:bg-gray-100 text-sm primary-text border-b">+ Create New Tag</button>
                            {allTags && allTags.length > 0 ? (
                                allTags.filter(t => !tags.includes(t)).map(t => (
                                    <button key={t} type="button" onClick={() => addExistingTag(t)} className="block w-full text-left px-4 py-2 hover:bg-blue-50 text-sm">{t}</button>
                                ))
                            ) : (
                                <div className="px-4 py-2 text-gray-400 text-sm">No existing tags</div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        function AddModal({ date, setDate, onAdd, onClose, allTags }) {
            const [id, setId] = useState('');
            const [name, setName] = useState('');
            const [score, setScore] = useState(3);
            const [tags, setTags] = useState([]);
            const [link, setLink] = useState('');
            const [error, setError] = useState('');

            useEffect(() => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                setDate(`${year}-${month}-${day}`);
            }, []);

            const handleLinkPaste = (e) => {
                const pastedText = e.target.value;
                setLink(pastedText);
                const parsed = parseLeetCodeURL(pastedText);
                if (parsed) {
                    setId(parsed.num);
                    setName(parsed.name);
                }
            };

            const submit = async () => {
                if (!id.trim()) {
                    setError('Please enter problem ID');
                    return;
                }
                setError('');
                const success = await onAdd(id.trim(), name, score, tags, link);
                if (success) onClose();
                else setError('Failed to add card');
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl p-8 w-[500px] max-h-[90vh] overflow-y-auto">
                        <h3 className="text-2xl font-bold mb-6">Add New Card</h3>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm mb-2 font-medium">LeetCode Link (Optional)</label>
                                <input type="text" value={link} onChange={handleLinkPaste} placeholder="https://leetcode.com/problems/..." className="w-full border-2 rounded px-4 py-3 text-sm" />
                                <p className="text-xs text-gray-500 mt-1">Paste LeetCode URL to auto-fill ID and name</p>
                            </div>
                            <div>
                                <label className="block text-sm mb-2 font-medium">Problem ID *</label>
                                <input type="text" value={id} onChange={(e) => { setId(e.target.value); setError(''); }} placeholder="e.g., 217" className="w-full border-2 rounded px-4 py-3" />
                            </div>
                            <div>
                                <label className="block text-sm mb-2 font-medium">Problem Name</label>
                                <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="e.g., Two Sum" className="w-full border-2 rounded px-4 py-3" />
                            </div>
                            <div>
                                <label className="block text-sm mb-2 font-medium">Completion Date</label>
                                <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="w-full border-2 rounded px-4 py-3" />
                            </div>
                            <div>
                                <label className="block text-sm mb-2 font-medium">Tags (Optional)</label>
                                <TagsInput tags={tags} setTags={setTags} allTags={allTags} />
                            </div>
                            <div>
                                <div className="flex items-center mb-2">
                                    <label className="text-sm font-medium">Rating (1-5)</label>
                                    <div className="relative ml-2 group">
                                        <span className="w-5 h-5 rounded-full border-2 border-gray-400 flex items-center justify-center text-gray-500 text-xs cursor-help">?</span>
                                        <div className="absolute left-0 top-7 w-64 bg-gray-800 text-white text-xs rounded-lg p-3 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 shadow-lg">
                                            <div className="space-y-1">
                                                <div><strong>1-Star:</strong> Unfamiliar</div>
                                                <div><strong>2-Star:</strong> Slightly Unfamiliar</div>
                                                <div><strong>3-Star:</strong> Moderately Familiar</div>
                                                <div><strong>4-Star:</strong> Quite Familiar</div>
                                                <div><strong>5-Star:</strong> Very Familiar</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex space-x-2">
                                    {[1, 2, 3, 4, 5].map(s => <button key={s} type="button" onClick={() => setScore(s)} className={`flex-1 py-3 rounded font-bold ${score === s ? 'primary-btn text-white' : 'bg-gray-100'}`}>{s}</button>)}
                                </div>
                            </div>
                            {error && <div className="bg-red-50 border-l-4 border-red-500 p-3 rounded"><p className="text-red-700 text-sm">{error}</p></div>}
                            <div className="flex space-x-3">
                                <button type="button" onClick={onClose} className="flex-1 border-2 rounded px-6 py-3 hover:bg-gray-50">Cancel</button>
                                <button type="button" onClick={submit} className="flex-1 primary-btn text-white rounded px-6 py-3">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function BatchModal({ date, setDate, onAdd, onClose }) {
            const [text, setText] = useState('');

            useEffect(() => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                setDate(`${year}-${month}-${day}`);
            }, []);

            const submit = async () => {
                const items = text.split('\n').filter(l => l.trim()).map(l => {
                    const [id, s] = l.split(':');
                    return { card_id: id.trim(), score: parseInt(s) || 3 };
                });
                if (items.length > 0 && await onAdd(items)) onClose();
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl p-8 w-[700px]">
                        <h3 className="text-2xl font-bold mb-6">Batch Add Cards</h3>
                        <div>
                            <label className="block text-sm mb-2 font-medium">Completion Date</label>
                            <input type="date" value={date} onChange={(e) => setDate(e.target.value)} className="mb-4 border-2 rounded px-4 py-2" />
                        </div>
                        <div>
                            <label className="block text-sm mb-2 font-medium">Format: ID:Score (one per line)</label>
                            <textarea value={text} onChange={(e) => setText(e.target.value)} className="w-full border-2 rounded px-4 py-3 h-64 font-mono text-sm" placeholder="Example:&#10;201:4&#10;202:3&#10;203:5" />
                        </div>
                        <div className="flex space-x-3 mt-4">
                            <button onClick={onClose} className="flex-1 border-2 rounded px-6 py-3 hover:bg-gray-50">Cancel</button>
                            <button onClick={submit} className="flex-1 primary-btn text-white rounded px-6 py-3">Submit</button>
                        </div>
                    </div>
                </div>
            );
        }

        function NoteEditor({ card, token, onSave, onClose }) {
            const [content, setContent] = useState(card.note || '');
            const ref = useRef(null);
            const q = useRef(null);

            useEffect(() => {
                if (!window.Quill) {
                    const link = document.createElement('link');
                    link.href = 'https://cdn.quilljs.com/1.3.6/quill.snow.css';
                    link.rel = 'stylesheet';
                    document.head.appendChild(link);
                    const script = document.createElement('script');
                    script.src = 'https://cdn.quilljs.com/1.3.6/quill.js';
                    script.onload = init;
                    document.body.appendChild(script);
                } else init();
            }, []);

            const init = () => {
                if (q.current || !ref.current) return;
                const quill = new window.Quill(ref.current, {
                    theme: 'snow',
                    modules: { toolbar: [['bold', 'italic'], ['code-block'], ['image']] },
                    placeholder: 'Enter notes...'
                });
                if (card.note) quill.root.innerHTML = card.note;
                quill.on('text-change', () => setContent(quill.root.innerHTML));
                quill.getModule('toolbar').addHandler('image', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.click();
                    input.onchange = () => {
                        const file = input.files[0];
                        if (file) {
                            const fd = new FormData();
                            fd.append('file', file);
                            fd.append('card_id', card.card_id);
                            fetch(`${API}/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd })
                                .then(r => r.json())
                                .then(d => {
                                    const range = quill.getSelection(true);
                                    quill.insertEmbed(range.index, 'image', `${API_ORIGIN}/api/images/${d.filename}`);
                                })
                                .catch(e => alert('Upload failed'));
                        }
                    };
                });

                quill.root.addEventListener('paste', (e) => {
                    const items = e.clipboardData.items;
                    for (let item of items) {
                        if (item.type.indexOf('image') !== -1) {
                            e.preventDefault();
                            const file = item.getAsFile();
                            const fd = new FormData();
                            fd.append('file', file);
                            fd.append('card_id', card.card_id);
                            fetch(`${API}/upload`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd })
                                .then(r => r.json())
                                .then(d => {
                                    const range = quill.getSelection(true);
                                    quill.insertEmbed(range.index, 'image', `${API_ORIGIN}/api/images/${d.filename}`);
                                })
                                .catch(e => alert('Upload failed'));
                        }
                    }
                });

                q.current = quill;
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl w-[90vw] h-[90vh] flex flex-col">
                        <div className="p-6 border-b flex justify-between" style={{ backgroundColor: '#F0F4FD' }}>
                            <h3 className="text-2xl font-bold">Card {card.card_id} - Notes</h3>
                            <button onClick={onClose} className="text-3xl hover:text-red-600">√ó</button>
                        </div>
                        <div className="flex-1 p-6 overflow-hidden">
                            <div ref={ref} className="h-full border-2 rounded overflow-y-auto" />
                        </div>
                        <div className="p-6 border-t flex justify-end space-x-4">
                            <button onClick={onClose} className="px-6 py-3 border-2 rounded hover:bg-gray-50">Cancel</button>
                            <button onClick={() => onSave(content)} className="px-6 py-3 primary-btn text-white rounded">Save</button>
                        </div>
                    </div>
                </div>
            );
        }

        function HistModal({ card, onClose }) {
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-2xl p-8 w-96">
                        <div className="flex justify-between mb-6">
                            <h3 className="text-xl font-bold">Card {card.card_id} - History</h3>
                            <button onClick={onClose} className="text-2xl hover:text-red-600">√ó</button>
                        </div>
                        <div className="space-y-2 text-sm">
                            <div><span className="text-gray-500">First Completed:</span> <span className="font-medium">{card.first_date}</span></div>
                            <div><span className="text-gray-500">Last Review:</span> <span className="font-medium">{card.last_review_date || card.first_date}</span></div>
                            <div><span className="text-gray-500">Review Count:</span> <span className="font-medium">{card.review_count || 0} times</span></div>
                            <div><span className="text-gray-500">Interval:</span> <span className="font-medium">{card.interval || 0} days</span></div>
                            <div><span className="text-gray-500">Next Review:</span> <span className="font-medium">{card.next_review || '-'}</span></div>
                        </div>
                        <button onClick={onClose} className="w-full mt-6 py-2 bg-gray-100 rounded hover:bg-gray-200">Close</button>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);

    </script>
</body>

</html>